var y=Object.defineProperty;var w=(i,t,a)=>t in i?y(i,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[t]=a;var s=(i,t,a)=>w(i,typeof t!="symbol"?t+"":t,a);class A{constructor(t,{rate:a=60}={}){s(this,"callback");s(this,"duration");s(this,"lastTime",0);s(this,"frameTime",0);s(this,"timer",0);s(this,"state","stop");s(this,"accumulateTime",0);this.callback=t,this.duration=Math.floor(1e3/a)}run(){this.state==="play"&&(this.timer=window.requestAnimationFrame(t=>{if(this.lastTime!==0){let a=t-this.lastTime;this.accumulateTime+=a,this.frameTime+=a,this.frameTime>=this.duration&&(this.frameTime%=this.duration,this.callback(a))}this.lastTime=t,this.run()}))}play(){this.state="play",this.run()}pause(){this.state="pause",window.cancelAnimationFrame(this.timer)}stop(){this.state="stop",window.cancelAnimationFrame(this.timer),this.accumulateTime=0,this.frameTime=0,this.lastTime=0}}class p{constructor(t,{center:a=!1,trace:n}={}){s(this,"trace");s(this,"center");s(this,"brush");s(this,"canvas");s(this,"context");s(this,"offscreenCanvas");s(this,"offscreenContext");s(this,"width");s(this,"height");if(this.trace=n,this.center=a,typeof t=="string"){let h=window.document.querySelector(t);if(!h)throw new Error(`Canvas Element not Found: ${t}.`);this.canvas=h}else this.canvas=t;this.context=this.canvas.getContext("2d"),this.width=Number.parseInt(this.canvas.getAttribute("width")??"")||this.canvas.clientWidth,this.height=Number.parseInt(this.canvas.getAttribute("height")??"")||this.canvas.clientHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.offscreenCanvas=new OffscreenCanvas(this.width,this.height),this.offscreenContext=this.offscreenCanvas.getContext("2d"),this.setTransform(),this.brush=new v(this.canvas,this.offscreenContext)}get wrap(){return[0,0,this.width,this.height]}get offscreenWrap(){return this.center?[-this.width/2,-this.height/2,this.width,this.height]:[0,0,this.width,this.height]}setTransform(){this.offscreenContext.scale(1,-1),this.center?this.offscreenContext.translate(this.width/2,-this.height/2):this.offscreenContext.translate(0,-this.height)}clearTransform(){this.center?this.offscreenContext.translate(-this.width/2,this.height/2):this.offscreenContext.translate(0,this.height),this.offscreenContext.scale(1,-1)}update(t){this.offscreenContext.clearRect(...this.offscreenWrap),this.trace&&this.trace<1&&(this.clearTransform(),this.offscreenContext.globalAlpha=this.trace,this.offscreenContext.drawImage(this.canvas,...this.wrap),this.setTransform(),this.offscreenContext.globalAlpha=1),this.offscreenContext.save(),t(this.brush),this.offscreenContext.restore(),this.context.clearRect(...this.wrap),this.context.drawImage(this.offscreenCanvas,...this.wrap)}}class v{constructor(t,a){s(this,"canvas");s(this,"context");this.canvas=t,this.context=a}drawCurve(t,{tension1:a=.15,tension2:n=.15,closed:h=!1}={}){if(t.length>=2){const r=e=>{let o=e[1].x+(e[2].x-e[0].x)*a,l=e[1].y+(e[2].y-e[0].y)*a,f=e[2].x-(e[3].x-e[1].x)*n,u=e[2].y-(e[3].y-e[1].y)*n;return{p1x:o,p1y:l,p2x:f,p2y:u}};if(this.context.beginPath(),h){this.context.moveTo(t[0].x,t[0].y);for(let c=1;c<t.length;c++){let{p1x:d,p1y:x,p2x:m,p2y:g}=r([t.at(c-2),t.at(c-1),t.at(c),t.at((c+1)%t.length)]);this.context.bezierCurveTo(d,x,m,g,t.at(c).x,t.at(c).y)}let e=0,{p1x:o,p1y:l,p2x:f,p2y:u}=r([t.at(e-2),t.at(e-1),t.at(e),t.at((e+1)%t.length)]);this.context.bezierCurveTo(o,l,f,u,t.at(e).x,t.at(e).y),this.context.closePath()}else{t=[t[0],...t,t[t.length-1]],this.context.moveTo(t[0].x,t[0].y);for(let e=2;e<t.length-1;e++){let{p1x:o,p1y:l,p2x:f,p2y:u}=r([t[e-2],t[e-1],t[e],t[e+1]]);this.context.bezierCurveTo(o,l,f,u,t[e].x,t[e].y)}}}}}const C=256;class b{constructor(t,{size:a=256,nodes:n=[]}={}){s(this,"nodes");s(this,"audio");s(this,"context");s(this,"source");s(this,"analyser");s(this,"buffer");s(this,"size");s(this,"handleAudioPlay",()=>{this.context.resume()});s(this,"handleAudioPause",()=>{this.context.suspend()});if(Math.log2(a)!==Math.floor(Math.log2(a))||a<1)throw new Error(`Invalid Size: ${a}. Must be a power of 2 greater than 0.`);if(this.size=a,this.nodes=n,this.buffer=new Uint8Array(this.size*2),typeof t=="string"){let r=window.document.querySelector(t);if(!r)throw new Error(`Audio Element not Found: ${t}.`);this.audio=r}else this.audio=t;this.audio.addEventListener("play",this.handleAudioPlay),this.audio.addEventListener("pause",this.handleAudioPause),this.context=new AudioContext,this.source=this.context.createMediaElementSource(this.audio),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=this.size*2;let h=this.source;for(let r of this.nodes)h.connect(r),h=r;h.connect(this.context.destination),h.connect(this.analyser)}get current(){return this.audio.currentTime}get duration(){return this.audio.duration}get progress(){return this.current/this.duration}get(t=!1){return t?this.analyser.getByteTimeDomainData(this.buffer):this.analyser.getByteFrequencyData(this.buffer),Array.from(this.buffer).slice(0,Math.floor(this.buffer.length/2)).map(n=>n/C)}dispose(){this.source.disconnect(),this.context.close(),this.audio.removeEventListener("play",this.handleAudioPlay),this.audio.removeEventListener("pause",this.handleAudioPause)}}export{A,p as P,b as T};
